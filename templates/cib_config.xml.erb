<?xml version="1.0" ?>
<cib admin_epoch="0" epoch="0" num_updates="0" validate-with="pacemaker-2.0">
  <configuration>
    <crm_config>
      <cluster_property_set id="cib-bootstrap-options">
<%
if @crm_config
  @crm_config.sort.each do |key, value|
-%>
        <nvpair id="cib-bootstrap-options-<%= key %>" name="<%= key %>" value="<%= @crm_config[key] %>"/>
<%
  end
end
-%>
      </cluster_property_set>
    </crm_config>
    <nodes>
<%
if @nodes
  @nodes.each do |node|
-%>
      <node id="<%= node %>" type="normal" uname="<%= node %>"/>
<%
  end
end
-%>
    </nodes>
    <resources>
<%
if @resources
  @resources.each do |res,conf|
    agent_class = conf['agent'].split(':')[0]
    agent_provider = conf['agent'].split(':')[1]
    agent_type = conf['agent'].split(':')[2]

    if conf['clone']
-%>
      <clone id="<%= res %>_clone">
<%
      if conf['clone_params']
-%>
        <meta_attributes id="<%= res %>_clone-meta_attributes">
<%
        conf['clone_params'].each do |p, val|
-%>
          <nvpair id="<%= res %>_clone-meta_attributes-<%= p %>" name="<%= p %>" value="<%= val %>"/>
<%
        end
-%>
        </meta_attributes>
<%
      end
    end
-%>
        <primitive class="<%= agent_class %>" id="<%= res %>" provider="<%= agent_provider %>" type="<%= agent_type %>">
<%
    if conf['params']
-%>
          <instance_attributes id="<%= res %>-instance_attributes">
<%
      conf['params'].sort.each do |p,val|
-%>
            <nvpair id="<%= res %>-instance_attributes-<%= p %>" name="<%= p %>" value="<%= val %>"/>
<%
      end
-%>
          </instance_attributes>
<%
    end
-%>
<%
    if conf['operations']
-%>
          <operations>
<%
      conf['operations'].each do |op,params|
        params.each do |p,val|
-%>
            <op id="<%= res %>-<%= op %>-<%= val %>" <%= p %>="<%= val %>" name="<%= op %>"/>
<%
        end
      end
-%>
          </operations>
<%
    end
-%>
        </primitive>
<%
    if conf['clone']
-%>
      </clone>
<%
    end
  end
end
-%>
    </resources>
    <constraints>
<%
if @constraints
  @constraints.each do |con,conf|
    if conf['type'] == 'order'
      score = conf['score'] || 'INFINITY'

      if conf.has?('resource_sets')
	rsc_id = conf['id']
-%>
      <rsc_order id="<%= rsc_id %>" score="<%= score %>" >

<%
	conf.each do |i, set|
	  set_id = set['id']

	  if set.has?('action')
	    set_action = set['action']
-%>
        <resource_set action="<%= set_action %>" id="<%= set_id %>" >
<%
	  else
-%>
	<resource_set id="<%= set_id %>" >
<%
	  end

	  set.each do |ref_id|
-%>
	  <resource_ref id="<%= ref_id %>" />
<%
	  end
-%>
	</resource_set>
<%
	end
-%>
      </rsc_order>
<%
      else
        first_id = conf['first'].split(':')[0]
        first_action = conf['first'].split(':')[1]
        then_id = conf['then'].split(':')[0]
        then_action = conf['then'].split(':')[1]
-%>
      <rsc_order first="<%= first_id %>" first-action="<%= first_action %>" id="<%= con %>" score="<%= score %>" then="<%= then_id %>" then-action="<%= then_action %>"/>
<%
      end
    else if conf['type'] == 'colocation'

    end
  end
end
-%>
    </constraints>
  </configuration>
</cib>
